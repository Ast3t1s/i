<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!--
        Данные, которые считаются статическими, могут безопасно перезаливаться целиком, чтобы быть всегда
        синхронизированными с csv файлами.
        Если все данные в таблице статические, то полностью очищаем таблицу, а потом заливаем заново с помощью loadData.
        Если часть данных являются статическими (как в Subject), то очищаем по условию, чтобы ненароком не удалить
        на продакшене динамическую часть, и заливаем с помощью loadData.
        Если данные перезаливаются с помощью loadUpdateData, то надо иметь в виду, что оно не поддерживает
        удаление данных. Т.е. если вы удалите строки из csv, то они не удалятся после исполнения loadUpdateData.
        Именно по этому loadUpdateData постепенно заменяется связкой: очистить таблицу, и вызвать loadData.

        Чтобы в процессе обновления данных не падали констрейнты, выполняется команда
        SET CONSTRAINTS ALL DEFERRED;
        Она означает, что все констрейнты надо проверять толкько при коммите транзакции, а коммит транзакции наступает
        после выполнения всех команд внутри changeSet. Таким образом, можно временно нарушать целостность данных, но
        в самом конце перед коммитом целостность должна быть восстановлена.
    -->
    <changeSet id="Update data" author="brunneng" runOnChange="true">

        <sql splitStatements="true" dbms="postgresql"><![CDATA[
            SET CONSTRAINTS ALL DEFERRED;

            DELETE FROM "ServiceTagRelation";
            DELETE FROM "ServiceTagLink";
            DELETE FROM "ServiceTag";
            DELETE FROM "ServiceTagType";
            DELETE FROM "SubjectOrganJoinTax";
            DELETE FROM "ObjectCustoms";
        ]]></sql>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/DocumentOperator_SubjectOrgan.csv" tableName="DocumentOperator_SubjectOrgan" separator=";">
            <column name="nID"              type="NUMERIC"/>
            <column name="sName"            type="STRING"/>
            <column name="nID_SubjectOrgan" type="NUMERIC"/>
            <column name="sHandlerClass"    type="String"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/ServiceOperator_SubjectOrgan.csv" tableName="ServiceOperator_SubjectOrgan" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sName" type="STRING"/>
            <column name="nID_SubjectOrgan" type="NUMERIC"/>
        </loadUpdateData>

        <loadData encoding="UTF-8" file="data/ServiceTagType.csv" tableName="ServiceTagType" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sName" type="STRING"/>
        </loadData>
        <loadData encoding="UTF-8" file="data/ServiceTag.csv" tableName="ServiceTag" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sID" type="STRING"/>
            <column name="sName_RU" type="STRING"/>
            <column name="sName_UA" type="STRING"/>
            <column name="nID_ServiceTagType" type="NUMERIC"/>
            <column name="nOrder" type="NUMERIC"/>
            <column name="sLinkImage" type="STRING"/>
            <column name="sNote" type="STRING"/>
        </loadData>
        <loadData encoding="UTF-8" file="data/ServiceTagLink.csv" tableName="ServiceTagLink" separator=";">
            <column name="nID_Service" type="NUMERIC"/>
            <column name="nID_ServiceTag" type="NUMERIC"/>
        </loadData>
        <loadData encoding="UTF-8" file="data/ServiceTagRelation.csv" tableName="ServiceTagRelation" separator=";">
            <column name="nID_ServiceTag_Parent" type="NUMERIC"/>
            <column name="nID_ServiceTag_Child" type="NUMERIC"/>
        </loadData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/Server.csv" tableName="Server" separator=";">
            <column name="nID"          type="NUMERIC"/>
            <column name="sID"          type="STRING"/>
            <column name="sType"        type="STRING"/>
            <column name="sURL_Alpha"   type="STRING"/>
            <column name="sURL_Beta"    type="STRING"/>
            <column name="sURL_Omega"   type="STRING"/>
            <column name="sURL"         type="STRING"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/DocumentContentType.csv" tableName="DocumentContentType" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sName" type="STRING"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/DocumentType.csv" tableName="DocumentType" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sName" type="STRING"/>
            <column name="bHidden" type="BOOLEAN"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/Document.csv" tableName="Document" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sName" type="STRING"/>
            <column name="nID_DocumentType" type="NUMERIC"/>
            <column name="sID_Content" type="STRING"/>
            <column name="nID_ContentType" type="NUMERIC"/>
            <column name="sFile" type="STRING"/>
            <column name="sID_Subject_Upload" type="STRING"/>
            <column name="sSubjectName_Upload" type="STRING"/>
            <column name="sDate_Upload" type="STRING"/>
            <column name="sContentType" type="STRING"/>
            <column name="nID_Subject" type="NUMERIC"/>
            <column name="nID_Subject_Upload" type="NUMERIC"/>
            <column name="oSignData" type="STRING"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/DocumentAccess.csv" tableName="DocumentAccess" separator=";">
            <column name="nID" type="NUMERIC" />
            <column name="nID_Document" type="NUMERIC"/>
            <column name="sDateCreate" type="STRING"/>
            <column name="nMS" type="NUMERIC"/>
            <column name="sFIO" type="STRING" />
            <column name="sTarget" type="STRING" />
            <column name="sTelephone" type="STRING" />
            <column name="sMail" type="STRING" />
            <column name="sSecret" type="STRING"/>
            <column name="sAnswer" type="STRING"/>
            <column name="sDateAnswerExpire" type="STRING"/>
        </loadUpdateData>

        <!-- 3 связанные таблицы SubjectOrganJoin, SubjectOrganJoinTax, SubjectOrganJoinAttribute
        перезагружаются каждый раз -->

        <loadData tableName="SubjectOrganJoinTax" file="data/SubjectOrganJoinTax.csv" encoding="UTF-8" separator=";">
            <column name="nID_SubjectOrganJoin" type="NUMERIC"/>
            <column name="sID_UA" type="STRING"/>
            <column name="sName_UA" type="STRING"/>
        </loadData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/HistoryEvent.csv" tableName="HistoryEvent" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="nID_Subject" type="NUMERIC"/>
            <column name="nID_HistoryEventType" type="NUMERIC"/>
            <column name="sEventName_Custom" type="STRING"/>
            <column name="sMessage" type="STRING"/>
            <column name="sDate" type="STRING"/>
            <column name="nID_HistoryEvent_Service" type="NUMERIC"/>
            <column name="nID_Document" type="NUMERIC"/>
            <column name="sSubjectInfo" type="STRING"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/Merchant.csv" tableName="Merchant" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="sID" type="STRING"/>
            <column name="sName" type="STRING"/>
            <column name="sPrivateKey" type="STRING"/>
            <column name="sURL_CallbackStatusNew" type="STRING"/>
            <column name="sURL_CallbackPaySuccess" type="STRING"/>
            <column name="nID_SubjectOrgan" type="NUMERIC"/>
            <column name="sID_Currency" type="STRING"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/Country.csv" tableName="Country" separator=";">
            <column name="nID" type="NUMERIC"/>
            <column name="nID_UA" type="NUMERIC"/>
            <column name="sID_Two" type="STRING"/>
            <column name="sID_Three" type="STRING"/>
            <column name="sNameShort_UA" type="STRING"/>
            <column name="sNameShort_EN" type="STRING"/>
            <column name="sReference_LocalISO" type="STRING"/>
        </loadUpdateData>

        <loadData tableName="ObjectCustoms" encoding="UTF-8" file="data/ObjectCustoms.csv" separator=";" >
            <column name="sID_UA" type = "STRING" />
            <column name="sName_UA" type = "STRING" />
            <column name="sMeasure_UA" type = "STRING" />
        </loadData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/Currency.csv" tableName="Currency" separator=";">
            <column name="nID"          type="NUMERIC"/>
            <column name="sID_UA"       type="STRING"/>
            <column name="sName_UA"     type="STRING"/>
            <column name="sName_EN"     type="STRING"/>
            <column name="sID_Currency" type="STRING"/>
        </loadUpdateData>

        <loadUpdateData primaryKey="nID" encoding="UTF-8" file="data/ObjectEarthTarget.csv" tableName="ObjectEarthTarget" separator=";">
            <column name="nID"        type="NUMERIC"/>
            <column name="sID_UA"     type="STRING"/>
            <column name="sName_UA"   type="STRING"/>
        </loadUpdateData>

         <loadUpdateData tableName="SubjectActionKVED" primaryKey="nID" encoding="UTF-8" file="data/SubjectActionKVED.csv" separator=";" >
            <column name="nID" type = "NUMERIC" />
            <column name="sID" type = "STRING" />
            <column name="sNote" type = "STRING" />
        </loadUpdateData>

         <loadUpdateData tableName="ObjectPlace_UA" primaryKey="nID" encoding="UTF-8" file="data/ObjectPlace_UA.csv" separator=";" >
            <column name="nID" type = "NUMERIC" />
            <column name="sID" type = "STRING" />
            <column name="sName_UA" type = "STRING" />
            <column name="nID_PlaceType" type = "NUMERIC" />
        </loadUpdateData>
    </changeSet>

</databaseChangeLog>